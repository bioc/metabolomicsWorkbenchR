---
title: "`r paste0('Metabolomics Workbench ',study_id)`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Study summary
```{r, echo=FALSE,results='asis'}
S=study_summary(study_id)
txt=S$study_summary
S$study_summary=NULL
knitr::kable(t(S))
cat('\n\n')
cat(txt)
```

# Data summary
```{r, echo=FALSE}
df=matrix(NA,nrow=3,ncol=2)
df[1,1]='Number of samples'
df[1,2]=nrow(DS)
df[2,1]='Number of features'
df[2,2]=ncol(DS)
df[3,1]='Number of factors'
df[3,2]=ncol(DS$sample_meta)
df=as.data.frame(df)
colnames(df)=c('','')
knitr::kable(df,bookdown=TRUE)
```
  
The factors are:

```{r,echo=FALSE}
options(knitr.kable.NA = '')
knitr::kable(summary(DS$sample_meta),bookdown=TRUE)
```
```{r, eval=nrow(DS$data)<10 | ncol(DS$data)<10,echo=FALSE}
cat('This dataset did not have enough samples/features for further analysis.')
knitr::knit_exit()
```

# Exploratory analysis
The data was processed using the following workflow:

1. Missing value feature filter (threshold = 60%)
2. Missing value sample filter (threshold = 60%)
3. Vector normalisation
4. KNN missing value imputation (5 neighbours)
5. Log transform (base 10)
6. Autoscaling
7. PCA

If the retrieved data has negative values it is assumed to already be processed and we go straight to PCA after imputing any missing values.

```{r,echo=FALSE,results='asis'}
SM=DS$sample_meta
if (all(DS$data>0,na.rm=TRUE)) {
M=  mv_feature_filter(threshold=40,method='across',factor_name=colnames(SM)[1]) +
    mv_sample_filter(mv_threshold=40) +
    vec_norm()+
    knn_impute(neighbours=5)+
    log_transform(base=10)+
    autoscale()+
    PCA(number_components=5)
    report=c('No negative values were detected.')
} else {
    M=mv_feature_filter(threshold=60,method='across',factor_name=colnames(SM)[1]) +
        mv_sample_filter(mv_threshold=60) +
        knn_impute(neighbours=5)+
        PCA(number_components=5)
    report=c('Negative values were detected.')
}
M=model_apply(M,DS)

cat(report)
```


After filtering there are `r nrow(predicted(M))` samples and `r ncol(predicted(M[length(M)-1]))` features.
  

```{r,echo=FALSE,fig.height=4.5, fig.width=8,fig.pos='htb!'}
for (k in seq(from=1,to=ncol(SM))) {
  
  nl=nlevels(SM[,k])
  if (nl<2 | nl==nrow(SM)){
    next
  }
  
    C=pca_scores_plot(factor_name=colnames(SM)[k],ellipse='none')
    G=chart_plot(C,M[length(M)])+ theme(legend.position="bottom",legend.direction = 'vertical',legend.text = element_text(size=8),legend.title=element_text(size=8))+guides(colour=guide_legend(ncol=3))
    leg=get_legend(G)
    G=G+theme(legend.position='none')
    g=plot_grid(G,leg,ncol=2)
    print(g)
}
```
